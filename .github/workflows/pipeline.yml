name: Project Pipeline

on:
  push:
    branches: [main, laszlo_veres]
  pull_request:
    branches: [laszlo_veres]
  workflow_dispatch:

concurrency:
  group: pages
  cancel-in-progress: true

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24.12.x'
      - name: Install dependencies
        run: npm ci
      - name: Install Playwright browsers
        run: npx playwright install --with-deps

  test:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
      - name: Install dependencies
        run: npm ci
      - name: Install Playwright browsers
        run: npx playwright install --with-deps
      - name: Run Playwright tests
        run: npx playwright test
      - name: Generate Allure report
        if: ${{ always() }}
        run: npx allure generate allure-results --clean -o allure-report
        continue-on-error: true
      - name: Ensure Allure report directory exists
        if: ${{ always() }}
        run: |
          if [ ! -d "allure-report" ]; then
            echo "No Allure report found; creating placeholder";
            mkdir -p allure-report;
            echo '<html><body><h1>No Allure Results</h1><p>Tests failed before results were generated.</p></body></html>' > allure-report/index.html;
          fi
          ls -la allure-report | head -n 50
      - name: Upload Pages artifact (Allure report)
        if: ${{ always() }}
        uses: actions/upload-pages-artifact@v3
        with:
          path: allure-report
      - name: Upload Allure report
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: allure-report/
          retention-days: 30

  deploy:
    runs-on: ubuntu-latest
    needs: test
    if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
    environment:
      name: github-pages
      url: https://vlaco1984.github.io/playwright-typescript-automation-framework/
    steps:
      - name: Download Allure report artifact
        uses: actions/download-artifact@v4
        with:
          name: allure-report
          path: allure-report
      - name: Compute timestamp
        id: ts
        run: echo "ts=$(date +'%Y%m%d-%H%M%S')" >> "$GITHUB_OUTPUT"
      - name: Publish Allure report with timestamped path
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: gh-pages
          folder: allure-report
          target-folder: reports/${{ steps.ts.outputs.ts }}
          clean: false
      - name: Publish index page listing all reports
        run: |
          BUILD_DIR=_pages_root
          mkdir -p "$BUILD_DIR"
          cat > "$BUILD_DIR/index.html" << 'EOF'
          <!doctype html>
          <html>
          <head>
            <meta charset="utf-8" />
            <title>Allure Reports Index</title>
            <style>body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:32px} a{color:#0366d6;text-decoration:none} a:hover{text-decoration:underline}</style>
          </head>
          <body>
            <h1>Allure Reports</h1>
            <p>Listing of timestamped reports under <code>/reports/</code>.</p>
            <ul id="list"></ul>
            <script>
              const owner = 'vlaco1984';
              const repo = 'playwright-typescript-automation-framework';
              const api = `https://api.github.com/repos/${owner}/${repo}/contents/reports?ref=gh-pages`;
              fetch(api).then(r=>r.json()).then(items=>{
                const ul=document.getElementById('list');
                if(!Array.isArray(items)) { ul.innerHTML = '<li>No reports yet</li>'; return; }
                items.filter(i=>i.type==='dir').sort((a,b)=>a.name<b.name?1:-1).forEach(i=>{
                  const li=document.createElement('li');
                  const a=document.createElement('a');
                  a.href = `./reports/${i.name}/index.html`;
                  a.textContent = i.name;
                  li.appendChild(a);
                  ul.appendChild(li);
                });
              }).catch(()=>{ document.getElementById('list').innerHTML = '<li>Could not load list</li>'; });
            </script>
          </body>
          </html>
          EOF
        shell: bash
      - name: Deploy index to gh-pages root
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: gh-pages
          folder: _pages_root
          clean: false
