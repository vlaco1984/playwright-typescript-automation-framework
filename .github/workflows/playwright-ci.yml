name: Playwright CI Pipeline

on:
  push:
    branches: [laszlo_veres]
  pull_request:
    branches: [laszlo_veres]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20.x'
      - name: Install dependencies
        run: npm ci
      - name: Install Playwright browsers
        run: npx playwright install --with-deps

  test:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20.x'
      - name: Install dependencies
        run: npm ci
      - name: Install Playwright browsers
        run: npx playwright install --with-deps
      - name: Run Playwright tests
        run: npx playwright test
      - name: Generate Allure report
        run: npx allure generate
      - name: Zip Allure report
        run: zip -r allure-report.zip allure-report
      - name: Output base64 of report zip
        run: base64 allure-report.zip > allure-report.zip.b64
      - name: Upload base64 as workflow summary
        run: |
          echo 'Download the Allure report, decode with base64, and unzip locally.' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat allure-report.zip.b64 >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
